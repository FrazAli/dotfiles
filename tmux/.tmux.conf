#
# Adds customizations to tmux settings and key bindings.
#

#
# Key Bindings
#

# Refresh tmux from config
unbind r
bind r source-file ~/.tmux.conf

# Additional split bindings for staying in current pane directory
bind-key -T prefix _ split-window -v -c '#{pane_current_path}'
bind-key -T prefix | split-window -h -c '#{pane_current_path}'

# Bind the Tab key to select previously active pane (-Z keeps pane zoomed)
bind-key -T prefix Tab last-pane -Z

# Open a popup shell from the prefix+Enter chord
bind-key -T prefix Enter display-popup -E -h 90% "zsh"

# Re-bind 'q' key to display pane IDs until a pane is selected
# (by default pane IDs disappear after one second)
bind-key -T prefix q display-panes -d 0

#
# Vim like pane navigation and resize
#

# Pane navigation on Ctrl-h/j/k/l (no prefix), so defaults like prefix+l still work
bind -n C-h select-pane -L
bind -n C-j select-pane -D
bind -n C-k select-pane -U
bind -n C-l select-pane -R
# Make the same work when in copy-mode-vi
bind -T copy-mode-vi C-h select-pane -L
bind -T copy-mode-vi C-j select-pane -D
bind -T copy-mode-vi C-k select-pane -U
bind -T copy-mode-vi C-l select-pane -R

# Resize panes on Prefix+Shift-h/j/k/l
unbind -T prefix H
unbind -T prefix J
unbind -T prefix K
unbind -T prefix L
bind -r -T prefix H resize-pane -L 5
bind -r -T prefix J resize-pane -D 5
bind -r -T prefix K resize-pane -U 5
bind -r -T prefix L resize-pane -R 5

#
# Settings and options
#

# increase console history
set-option -g history-limit 100000

# set vim like keys
set-option -g status-keys vi
set-option -g mode-keys vi

# Address neovim mode switching delay (http://superuser.com/a/252717/65504), default: 500
set-option -sg escape-time 0

# Set color settings as recommended by neovim
set-option -g default-terminal "tmux-256color"

# Set focus events for `autoread` in neovim
set-option -g focus-events on

# Truecolor fix inside tmux (replace old overrides)
# Hint tmux/outer terminals that 24-bit RGB is supported
set -as terminal-features "xterm-256color:RGB,tmux-256color:RGB,wezterm:RGB,ghostty:RGB,alacritty*:RGB,kitty:RGB,foot:RGB"
# Fallback for older tmux/ncurses that still look for Tc
set -ga terminal-overrides ",*:Tc"

# Increase tmux messages display duration from 750ms to 4s
set-option -g display-time 4000

# Refresh 'status-left' and 'status-right' more often, from every 15s to 10s
set-option -g status-interval 10

# Useful when using "grouped sessions" and multi-monitor setup
set-option -g aggressive-resize on

# Enable Mouse
set-option -g mouse on

# Start window and panes indexing from 1 instead of 0
set-option -g base-index 1
set-option -g pane-base-index 1

# Renumber all windows when any window is closed
set-option -g renumber-windows on

#
# Theme
#

# Nord theme colors
gray_light="#d8dee9"
gray_medium="#abb2bf"
gray_dark="#3b4252"
blue="#5e81ac"
blue_muted="#81a1c1"
cyan_soft="#88c0d0"
red="#bf616a"
green="#a3be8c"
yellow="#ebcb8b"

# Custom colors
gray_nvim="#2e3440"
green_bright="#33DD33"
blue_bright="#89b4fa"

# Move status bar to the top
set-option -g status-position top

# Display session number before first window
set -g status-left " #[bold,fg=${blue_bright},bg=default]#S#[fg=#{gray_medium},bg=default] |"

# set window title to current dirname
set -g automatic-rename on
set -g window-status-format "#[fg=${gray_medium},bg=default] #{?window_active,,#I:}#{b:pane_current_path}#{?window_zoomed_flag,  ,}"
set -g window-status-current-format "#[bold,fg=${blue_bright},bg=default]  #{b:pane_current_path}#{?window_zoomed_flag,  ,}"

# Keybinding to toggle between transparent and Nord background using tmux options
bind-key T run-shell '
  CURRENT_STYLE=$(tmux show-options -g status-style 2>/dev/null | sed -n "s/.*bg=\([^,]*\).*/\1/p")
  CURRENT_STYLE=${CURRENT_STYLE:-default}

  if [ "$CURRENT_STYLE" = "default" ] || [ "$CURRENT_STYLE" = "none" ]; then
    tmux set -g status-style "bg=${gray_nvim},fg=default"
    tmux set -g @_ctp_status_bg "${gray_nvim}"
    tmux set -g message-style "fg=${yellow},bg=${gray_nvim},align=centre"
    tmux set -g message-command-style "fg=${yellow},bg=${gray_nvim},align=centre"
    # tmux display-message "Background: Nord Theme"
  else
    tmux set -g status-style "bg=default,fg=default"
    tmux set -g message-style "fg=${yellow},bg=default,align=centre"
    tmux set -g message-command-style "fg=${yellow},bg=default,align=centre"
    # tmux display-message "Background: Transparent"
  fi
'

# Ensure that everything on the right side of the status line is given 100 chars
set -g status-right-length 100

# Cache the configuration directory (resolve symlinks) for helper scripts
run-shell 'CONFIG_FILE="#{config_file}"; [ -z "$CONFIG_FILE" ] && CONFIG_FILE="$HOME/.tmux.conf"; while [ -L "$CONFIG_FILE" ]; do LINK=$(readlink "$CONFIG_FILE"); case "$LINK" in /*) CONFIG_FILE="$LINK" ;; *) CONFIG_FILE="$(dirname "$CONFIG_FILE")/$LINK" ;; esac; done; CONFIG_DIR=$(CDPATH= cd "$(dirname "$CONFIG_FILE")" && pwd -P); tmux set -g @config_dir "$CONFIG_DIR"'

# Resolve script path even when ~/.tmux.conf is a symlink
set -g status-right "#[fg=${gray_medium}]#[bg=default]#(cd \"#{@config_dir}\" && ./plugins/utils/cpu-mem-status.sh) | "
set -ag status-right "#[fg=${gray_medium}]#[bg=default]#(cd \"#{@config_dir}\" && ./plugins/utils/battery-status.sh)"
# set -ag status-right " |#[fg=${gray_medium},bg=default] %Y-%m-%d"
set -ag status-right " |#[fg=${blue_bright},bg=default]  %H:%M "

#
#-option Configure plugins
#

# Allows-option to preserve and restore tmux session form disk
run-shell ~/.tmux/plugins/tmux-resurrect/resurrect.tmux

# Automates-option tmux session backup / restore using 'tmux-resurrect'
run-shell ~/.tmux/plugins/tmux-continuum/continuum.tmux
# Auto-restore last saved session when tmux is started.
set-option -g @continuum-restore 'on'
